{% load staticfiles %}
<script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
<script src="{% static "lib/vis/vis.js" %}"></script>
<link rel="stylesheet" href="{% static "configurator/style.css" %}"/>
<link href="{% static "lib/vis/vis.css" %}" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
      crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"
      crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>

<script type="text/javascript">
    function color_nodes(items) {
        var colors = {
            router: {
                border: '#2B7CE9',
                background: '#D2E5FF'
            },
            client: {
                border: 'lightgray',
                background: 'lightgray',
                highlight: {
                    border: 'gray',
                    background: 'lightgray'
                }
            },
            lan: 'white'
        };
        items.forEach(function (id) {
            var node = nodes.get(id);
            if (!node.color) {
                node['color'] = colors[node.properties.type]
                nodes.update(node)
            }
        });
    }

    /* GLOBALS */
    var nodes, edges, network;
    function draw() {

        {% include "initial_data.js" %}

        // create an array with nodes
        nodes = new vis.DataSet();
        nodes.on('*', function (kind, event) {
            if (kind != 'remove')color_nodes(event.items);
            document.getElementById('nodes').innerHTML = JSON.stringify(nodes.get(), null, 4);
        });
        nodes.add(initial_nodes);


        // create an array with edges
        edges = new vis.DataSet();
        edges.on('*', function () {
            document.getElementById('edges').innerHTML = JSON.stringify(edges.get(), null, 4);
        });
        edges.add(initial_edges);

        // create a network
        var container = document.getElementById('network');
        var data = {
            nodes: nodes,
            edges: edges
        };
        var options = {};
        network = new vis.Network(container, data, options);

        network.on("doubleClick", function (params) {
            if (params.nodes[0]) {
                var node = nodes.get(params.nodes[0]);
                if (node.properties.type === 'client') {
                    $('#clientNodeID').val(node.id);
                    $('#clientNodeLabel').val(node.label);
                    $('#clientNodeNetwork').val(node.properties.network);
                    $('#clientNodeIP').val(node.properties.ip);
                    $('#clientNodeGateway').val(node.properties.gateway);
                    $('#clientNodeModal').modal('show')
                } else if (node.properties.type === 'lan') {
                    $('#lanNodeID').val(node.id);
                    $('#lanNodeLabel').val(node.label);
                    $('#lanNodeSubnet').val(node.properties.subnet);
                    $('#lanNodeModal').modal('show')
                } else {
                    $('#routerNodeID').val(node.id);
                    $('#routerNodeLabel').val(node.label);
                    $('#routerNodeModal').modal('show')
                }
            } else if (params.edges[0]) {
                var edge = edges.get(params.edges[0]);
                if (edge.properties.type === 'client') {
                    $('#clientEdgeID').val(edge.id);
                    $('#clientEdgeFrom').val(edge.from);
                    $('#clientEdgeTo').val(edge.to);
                    $('#clientEdgeIP').val(edge.properties.ip);
                    $('#clientEdgeGateway').val(edge.properties.gateway);
                    $('#clientEdgeModal').modal('show')
                } else {
                    $('#routerEdgeID').val(edge.id);
                    $('#routerEdgeFrom').val(edge.from);
                    $('#routerEdgeTo').val(edge.to);
                    $('#routerEdgeIP').val(edge.properties.ip);
                    $('#routerEdgeModal').modal('show')
                }
            }
        });
    }

    $(document).ready(draw);
    $(document).ready(function () {
        $('#lanNodeSave').click(function () {
            nodes.update({
                id: $('#lanNodeID').val(),
                label: $('#lanNodeLabel').val(),
                properties: {
                    subnet: $('#clientNodeSubnet').val(),
                    type: "lan"
                }
            });
            $('#lanNodeModal').modal('hide')
        });
        $('#clientNodeSave').click(function () {
            nodes.update({
                id: $('#clientNodeID').val(),
                label: $('#clientNodeLabel').val(),
                properties: {
                    network: $('#clientNodeNetwork').val(),
                    ip: $('#clientNodeIP').val(),
                    gateway: $('#clientNodeGateway').val(),
                    type: "client"
                }
            });
            $('#clientNodeModal').modal('hide')
        });
        $('#routerNodeSave').click(function () {
            nodes.update({
                id: $('#routerNodeID').val(),
                label: $('#routerNodeLabel').val(),
                properties: {
                    type: "router"
                }
            });
            $('#routerNodeModal').modal('hide')
        });
        $('#routerEdgeSave').click(function () {
            edges.update({
                id: $('#routerEdgeID').val(),
                from: $('#routerEdgeFrom').val(),
                to: $('#routerEdgeTo').val(),
                properties: {
                    ip: $('#routerEdgeIP').val(),
                    type: "router"
                }
            });
            $('#routerEdgeModal').modal('hide')
        });
        $('#clientEdgeSave').click(function () {
            edges.update({
                id: $('#clientEdgeID').val(),
                from: $('#clientEdgeFrom').val(),
                to: $('#clientEdgeTo').val(),
                properties: {
                    gateway: $('#clientEdgeGateway').val(),
                    ip: $('#clientEdgeIP').val(),
                    type: "client"
                }
            });
            $('#clientEdgeModal').modal('hide')
        });

        function getData() {
            return {
                csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val(),
                nodes: JSON.stringify(nodes.get()),
                edges: JSON.stringify(edges.get())
            }
        }

        $("#generate").click(function () {
            $.post({
                url: "configurator/generate",
                dataType: "json",
                data: getData(),
            })
        });
        $("#run").click(function () {
            $.post({
                url: "configurator/run",
                dataType: "json",
                data: getData()
            })
        });

        $("#get_design").click(function () {
            $.post({
                url: "configurator/generate",
                dataType: "json",
                data: getData()
            }).done(function () {
                window.open('configurator/get_design', '_blank');
            })
        });
        $('#design_file').on('change', function () {
            var formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('design_file', $('#design_file')[0].files[0]);
            $.ajax({
                url: "configurator/set_design",
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                type: 'POST'
            }).done(function () {
                location.reload();
            });
        });

        $("#reset_design").click(function () {
            $.post({
                url: "configurator/reset_design",
                data: {
                    csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val()
                }
            }).done(function () {
                location.reload();
            });
        });
    })

</script>

<nav class="navbar navbar-default">
    {% csrf_token %}
    <div class="container">
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li><a id="generate" href="#">Save design</a></li>
                <li><a id="get_design" href="#">Get design</a></li>
                <li><a id="reset_design" href="#">Reset design</a></li>
                <li>
                    <a id="set_design" href="#" onclick="$('#design_file').click()">Set design</a>
                    <input type="file" name="design_file" id="design_file" style="display: none"/>
                </li>
                <li><a id="get_project" href="#">Get project</a></li>
                <li><a id="run" href="#">Run project</a></li>
            </ul>
        </div>
    </div>
</nav>

{% include "modals.html" %}
<div id="network" style="height: 800px"></div>

<table class="view" style="width: 100%">
    <colgroup>
        <col width="50%">
        <col width="50%">
    </colgroup>
    <tr>
        <td>
            <h2>Nodes</h2>
            <pre id="nodes"></pre>
        </td>

        <td>
            <h2>Edges</h2>
            <pre id="edges"></pre>
        </td>
    </tr>
</table>



