{% load staticfiles %}
<script src="{% static "lib/jquery-1.12.0.min.js" %}"></script>
<script src="{% static "lib/vis/vis.js" %}"></script>
<link href="{% static "lib/vis/vis.css" %}" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="{% static "lib/bootstrap.min.css" %}" crossorigin="anonymous">
<link rel="stylesheet" href="{% static "lib/bootstrap-theme.min.css" %}" crossorigin="anonymous">
<script src="{% static "lib/bootstrap.min.js" %}" crossorigin="anonymous"></script>
<link rel="stylesheet" href="{% static "configurator/style.css" %}"/>

<script type="text/javascript">

 /* GLOBALS */
    var nodes, edges, network;


    function color_nodes(items) {
        var colors = {
            router: {
                border: '#2B7CE9',
                background: '#D2E5FF'
            },
            client: {
                border: 'lightgray',
                background: 'lightgray',
                highlight: {
                    border: 'gray',
                    background: 'lightgray'
                }
            },
            lan: 'white'
        };
        items.forEach(function (id) {
            var node = nodes.get(id);
            if (!node.color) {
                node['color'] = colors[node.properties.type];
                nodes.update(node)
            }
        });
    }

     function getRouters(){
        var routers = [];
        var tmpNodes = nodes.get();
        for (var node in tmpNodes) {
            if (tmpNodes[node].properties.type === 'router') {
                routers.push(tmpNodes[node].id);
            }
        }
        return routers;
    }

    function getClients(){
        var clients = [];
        var tmpNodes = nodes.get();
        for (var node in tmpNodes) {
            if (tmpNodes[node].properties.type === 'client') {
                clients.push(tmpNodes[node].id);
            }
        }
        return clients;
    }

    function getLans(){
        var lans = [];
        var tmpNodes = nodes.get();
        for (node in tmpNodes) {
            if (tmpNodes[node].properties.type === 'lan') {
                lans.push(tmpNodes[node].id);
            }
        }
        return lans;
    }

    function setSelectionsRouterLan(){
        var routers = getRouters();
        var lans = getLans();
         $('#routerEdgeIP').empty();
        $('#routerEdgeID').empty();
        $('#routerEdgeFrom').empty();
        $('#routerEdgeTo').empty();
        $(routers).each(function(i, v){
            $('#routerEdgeFrom').append($("<option>", { value: v, html: v }));
        });

        $(lans).each(function(i, v){
             $('#routerEdgeTo').append($("<option>", { value: v, html: v }));
        });
    }

     function setSelectionsClientLan(){
        var clients = getClients();
        var lans = getLans();
        $('#clientEdgeID').empty();
        $('#clientEdgeIP').empty();
        $('#clientEdgeGateway').empty();
        $('#clientEdgeFrom').empty();
        $('#clientEdgeTo').empty();
        $(clients).each(function(i, v){
            $('#clientEdgeFrom').append($("<option>", { value: v, html: v }));
        });

        $(lans).each(function(i, v){
             $('#clientEdgeTo').append($("<option>", { value: v, html: v }));
        });
    }


    function draw() {

        {% include "initial_data.js" %}

        // create an array with nodes
        nodes = new vis.DataSet();
        nodes.on('*', function (kind, event) {
            if (kind != 'remove')color_nodes(event.items);
            document.getElementById('nodes').innerHTML = JSON.stringify(nodes.get(), null, 4);
        });
        nodes.add(initial_nodes);


        // create an array with edges
        edges = new vis.DataSet();
        edges.on('*', function () {
            document.getElementById('edges').innerHTML = JSON.stringify(edges.get(), null, 4);
        });
        edges.add(initial_edges);

        // create a network
        var container = document.getElementById('network');
        var data = {
            nodes: nodes,
            edges: edges
        };
        var options = {};
        network = new vis.Network(container, data, options);



        network.on("doubleClick", function (params) {
            if (params.nodes[0]) {
                var node = nodes.get(params.nodes[0]);
                if (node.properties.type === 'client') {
                    $('#clientNodeID').val(node.id);
                    $('#clientNodeLabel').val(node.label);
                    $('#clientNodeModal').modal('show')
                } else if (node.properties.type === 'lan') {
                    $('#lanNodeID').val(node.id);
                    $('#lanNodeSubnet').val(node.properties.subnet);
                    $('#lanNodeModal').modal('show')
                } else {
                    $('#routerNodeID').val(node.id);
                    $('#routerNodeModal').modal('show')
                }
            } else if (params.edges[0]) {
                var edge = edges.get(params.edges[0]);
                if (edge.properties.type === 'client') {
                    setSelectionsClientLan();
                    $('#clientEdgeID').val(edge.id);
                    $('#clientEdgeFrom').val(edge.from);
                    $('#clientEdgeTo').val(edge.to);
                    $('#clientEdgeIP').val(edge.properties.ip);
                    $('#clientEdgeGateway').val(edge.properties.gateway);
                    $('#clientEdgeModal').modal('show')
                } else {
                    setSelectionsRouterLan();
                    $('#routerEdgeID').val(edge.id);
                    $('#routerEdgeFrom').val(edge.from);
                    $('#routerEdgeTo').val(edge.to);
                    $('#routerEdgeIP').val(edge.properties.ip);
                    $('#routerEdgeModal').modal('show')
                }
            }
        });
    }

    $(document).ready(draw);
    $(document).ready(function () {

        $('#routerLinkCreate').click(function () {
            setSelectionsRouterLan();
            $('#routerEdgeModal').modal('show')
        });

         $('#clientLinkCreate').click(function () {
            setSelectionsClientLan();
            $('#clientEdgeModal').modal('show')
        });

        $('#lanNodeDelete').click(function () {
            nodes.remove($('#lanNodeID').val());
            $('#lanNodeModal').modal('hide')
        });
        $('#clientNodeDelete').click(function () {
            nodes.remove($('#clientNodeID').val());
            $('#clientNodeModal').modal('hide')
        });
        $('#routerNodeDelete').click(function () {
            nodes.remove($('#routerNodeID').val());
            $('#routerNodeModal').modal('hide')
        });
        $('#clientEdgeDelete').click(function () {
            edges.remove($('#clientEdgeID').val());
            $('#clientEdgeModal').modal('hide')
        });
        $('#routerEdgeDelete').click(function () {
            edges.remove($('#routerEdgeID').val());
            $('#routerEdgeModal').modal('hide')
        });
        $('#lanNodeSave').click(function () {
            nodes.update({
                id: $('#lanNodeID').val(),
                label: $('#lanNodeID').val(),
                properties: {
                    subnet: $('#clientNodeSubnet').val(),
                    type: "lan"
                }
            });
            $('#lanNodeModal').modal('hide')
        });
        $('#clientNodeSave').click(function () {
            nodes.update({
                id: $('#clientNodeID').val(),
                label: $('#clientNodeID').val(),
                properties: {
                    network: $('#clientNodeNetwork').val(),
                    ip: $('#clientNodeIP').val(),
                    gateway: $('#clientNodeGateway').val(),
                    type: "client"
                }
            });
            $('#clientNodeModal').modal('hide')
        });
        $('#routerNodeSave').click(function () {
            nodes.update({
                id: $('#routerNodeID').val(),
                label: $('#routerNodeID').val(),
                properties: {
                    type: "router"
                }
            });
            $('#routerNodeModal').modal('hide')
        });
        $('#routerEdgeSave').click(function () {
            edges.update({
                id: $('#routerEdgeID').val(),
                from: $('#routerEdgeFrom').val(),
                to: $('#routerEdgeTo').val(),
                properties: {
                    ip: $('#routerEdgeIP').val(),
                    type: "router"
                }
            });
            $('#routerEdgeModal').modal('hide')
        });
        $('#clientEdgeSave').click(function () {
            edges.update({
                id: $('#clientEdgeID').val(),
                from: $('#clientEdgeFrom').val(),
                to: $('#clientEdgeTo').val(),
                properties: {
                    gateway: $('#clientEdgeGateway').val(),
                    ip: $('#clientEdgeIP').val(),
                    type: "client"
                }
            });
            $('#clientEdgeModal').modal('hide')
        });



        function getData() {
            return {
                csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val(),
                nodes: JSON.stringify(nodes.get()),
                edges: JSON.stringify(edges.get())
            }
        }

        $("#generate").click(function () {
            $.post({
                url: "configurator/generate",
                dataType: "json",
                data: getData()
            })
        });
        $("#run").click(function () {
            $('#runModal').modal('show');
            $.post({
                url: "configurator/run",
                dataType: "json",
                data: getData()
            }).done(function (result) {
                $('#runModal').modal('hide');
            })
        });
        $("#stop").click(function () {
            $('#stopModal').modal('show');
            $.post({
                url: "configurator/stop",
                dataType: "json",
                data: {csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val()}
            }).done(function (result) {
                $('#stopModal').modal('hide');
            })
        });

        $("#get_design").click(function () {
            $.post({
                url: "configurator/generate",
                dataType: "json",
                data: getData()
            }).done(function () {
                window.open('configurator/get_design', '_blank');
            })
        });
        $('#design_file').on('change', function () {
            var formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('design_file', $('#design_file')[0].files[0]);
            $.ajax({
                url: "configurator/set_design",
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                type: 'POST'
            }).done(function () {
                location.reload();
            });
        });

        $("#reset_design").click(function () {
            $.post({
                url: "configurator/reset_design",
                data: {
                    csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val()
                }
            }).done(function () {
                location.reload();
            });
        });
    })


</script>

<div class="modal" id="runModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Run your configuration</h4>
            </div>
            <div class="modal-body">
                <div id="runProgress" class="progress">
                    <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100"
                         aria-valuemin="0" aria-valuemax="100" style="width:100%">
                        Working..
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="stopModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Stopping running containers</h4>
            </div>
            <div class="modal-body">
                <div id="runProgress" class="progress">
                    <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100"
                         aria-valuemin="0" aria-valuemax="100" style="width:100%">
                        Working..
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<nav class="navbar navbar-default">
    {% csrf_token %}
    <div class="container">
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li><a id="generate" href="#">Save design</a></li>
                <li><a id="get_design" href="#">Get design</a></li>
                <li><a id="reset_design" href="#">Reset design</a></li>
                <li>
                    <a id="set_design" href="#" onclick="$('#design_file').click()">Set design</a>
                    <input type="file" name="design_file" id="design_file" style="display: none"/>
                </li>

                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                       aria-expanded="false">Add<span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="#" data-toggle="modal" data-target="#routerNodeModal">router</a></li>
                        <li><a href="#" data-toggle="modal" data-target="#clientNodeModal">client</a></li>
                        <li><a href="#" data-toggle="modal" data-target="#lanNodeModal">lan</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a id="routerLinkCreate" href="#">router link</a></li>
                        <li><a id="clientLinkCreate" href="#">client link</a></li>
                    </ul>
                <li><a id="get_project" href="#">Get project</a></li>
                <li><a id="run" href="#">Run project</a></li>
                <li><a id="stop" href="#">Stop running</a></li>
            </ul>
        </div>
    </div>
</nav>

{% include "modals.html" %}
<div id="network" style="height: 800px"></div>

<table class="view" style="width: 100%">
    <colgroup>
        <col width="50%">
        <col width="50%">
    </colgroup>
    <tr>
        <td>
            <h2>Nodes</h2>
            <pre id="nodes"></pre>
        </td>

        <td>
            <h2>Edges</h2>
            <pre id="edges"></pre>
        </td>
    </tr>
</table>



